# –ë–µ–Ω—á–º–∞—Ä–∫–∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–∫–æ—Ä–æ—Å—Ç–µ–π

## –û–ø–∏—Å–∞–Ω–∏–µ –±–µ–Ω—á–º–∞—Ä–∫–æ–≤

### 1. `benchmark_velocity_analysis`
–ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∫–∞–ø–µ–ª—å **–° –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–º–∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ (PBC)**

**–ß—Ç–æ —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç:**
- –ù–∞–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥: O(N¬≤) —Å–∏–ª—ã + O(N¬≤) –∫–æ–Ω–≤–µ–∫—Ü–∏—è (—ç—Ç–∞–ª–æ–Ω)
- –ì–∏–±—Ä–∏–¥–Ω—ã–π: O(N log N) —Å–∏–ª—ã —á–µ—Ä–µ–∑ –æ–∫—Ç–æ–¥–µ—Ä–µ–≤–æ + O(N¬≤) –∫–æ–Ω–≤–µ–∫—Ü–∏—è
- –ü–æ–ª–Ω–æ–µ –æ–∫—Ç–æ–¥–µ—Ä–µ–≤–æ: O(N log N) —Å–∏–ª—ã + O(N log N) –∫–æ–Ω–≤–µ–∫—Ü–∏—è

**–†–∞–∑–º–µ—Ä—ã —Å–∏—Å—Ç–µ–º:** 10,000 / 50,000 / 100,000 –∫–∞–ø–µ–ª—å

### 2. `benchmark_velocity_no_pbc`
–ê–Ω–∞–ª–∏–∑ –ø–æ–ª–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∫–∞–ø–µ–ª—å **–ë–ï–ó –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π**

**–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≤–Ω–æ—Å—è—Ç –ª–∏ PBC –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏

**–†–∞–∑–º–µ—Ä—ã —Å–∏—Å—Ç–µ–º:** 1,000 / 5,000 / 10,000 –∫–∞–ø–µ–ª—å

## –ó–∞–ø—É—Å–∫

```bash
# –ò–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
cd build

# –° PBC (–±–æ–ª—å—à–∏–µ —Å–∏—Å—Ç–µ–º—ã)
./benchmark_velocity_analysis [theta] [max_droplets_per_leaf] [volume_fraction]

# –ë–µ–∑ PBC (–º–µ–Ω—å—à–∏–µ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
./benchmark_velocity_no_pbc [theta] [max_droplets_per_leaf] [box_size]

# –ü—Ä–∏–º–µ—Ä—ã:
./benchmark_velocity_analysis 0.25 16 0.02
./benchmark_velocity_no_pbc 0.25 16 0.001
```

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è

### ‚úÖ –í—ã–≤–æ–¥—ã –∏–∑ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (–ü–û–°–õ–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ô):

1. **PBC –ù–ï –≤–Ω–æ—Å—è—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫** - –æ—à–∏–±–∫–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã —Å PBC –∏ –±–µ–∑ PBC

2. **–ì–∏–±—Ä–∏–¥–Ω—ã–π –º–µ—Ç–æ–¥ –û–¢–õ–ò–ß–ù–´–ô:**
   - –û—à–∏–±–∫–∏ <10% –º–∞–∫—Å–∏–º—É–º, <0.3% –≤ —Å—Ä–µ–¥–Ω–µ–º
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—Å–µ –∫–∞–ø–ª–∏ (>99.9%) –∏–º–µ—é—Ç –æ—à–∏–±–∫—É <10%
   - –û–∫—Ç–æ–¥–µ—Ä–µ–≤–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –¥–∏–ø–æ–ª—å–Ω—ã—Ö —Å–∏–ª

3. **–ü–æ–ª–Ω–æ–µ –æ–∫—Ç–æ–¥–µ—Ä–µ–≤–æ –•–û–†–û–®–ï–ï (–ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π):**
   - –î–û: –û—à–∏–±–∫–∏ –¥–æ 1238% –º–∞–∫—Å–∏–º—É–º, ~27% –≤ —Å—Ä–µ–¥–Ω–µ–º ‚ùå
   - –ü–û–°–õ–ï: –û—à–∏–±–∫–∏ –¥–æ 153% –º–∞–∫—Å–∏–º—É–º, ~3.4% –≤ —Å—Ä–µ–¥–Ω–µ–º ‚úì
   - **–£–õ–£–ß–®–ï–ù–ò–ï –í 8 –†–ê–ó** –±–ª–∞–≥–æ–¥–∞—Ä—è –æ—Ç–¥–µ–ª—å–Ω–æ–º—É theta_convection!
   - –¢–æ–ª—å–∫–æ ~6.5% –∫–∞–ø–µ–ª—å –∏–º–µ—é—Ç –æ—à–∏–±–∫—É >10%

### üî¨ –§–∏–∑–∏—á–µ—Å–∫–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ:

- **–î–∏–ø–æ–ª—å–Ω–∞—è —Å–∏–ª–∞:** F ‚àù 1/r‚Å∑ ‚Üí –±—ã—Å—Ç—Ä–æ –∑–∞—Ç—É—Ö–∞–µ—Ç ‚Üí theta=0.25 –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
- **–°—Ç–æ–∫—Å–ª–µ—Ç:** u ‚àù 1/r –∏ 1/r¬≥ ‚Üí –º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞—Ç—É—Ö–∞–µ—Ç ‚Üí –Ω—É–∂–µ–Ω theta=0.025 (–≤ 10x —Å—Ç—Ä–æ–∂–µ!)

**–†–ï–®–ï–ù–ò–ï:** –û—Ç–¥–µ–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π theta_convection –¥–ª—è —Å—Ç–æ–∫—Å–ª–µ—Ç–∞!

### üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

**üéØ –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è):**
```cpp
// –°–∏–ª—ã —á–µ—Ä–µ–∑ –æ–∫—Ç–æ–¥–µ—Ä–µ–≤–æ - –±—ã—Å—Ç—Ä–æ –∏ —Ç–æ—á–Ω–æ
system.calculateDipoleForces();

// –ö–æ–Ω–≤–µ–∫—Ü–∏—è —Ç–æ—á–Ω–æ O(N¬≤) - –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –Ω–æ –æ—à–∏–±–∫–∞ <1%
calculateConvectionNaive(system, stokeslet_calc);
```

**‚ö° –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏:**
```cpp
// –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–ª–Ω–æ–µ –æ–∫—Ç–æ–¥–µ—Ä–µ–≤–æ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º theta_convection
system.setOctreeTheta(0.25);
octree->setThetaConvection(0.025);  // –í 10x —Å—Ç—Ä–æ–∂–µ –¥–ª—è —Å—Ç–æ–∫—Å–ª–µ—Ç–∞!

system.calculateDipoleForces();
system.calculateConvectionVelocities();  // –ß–µ—Ä–µ–∑ –æ–∫—Ç–æ–¥–µ—Ä–µ–≤–æ, –æ—à–∏–±–∫–∞ ~3-5%
```

**üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ theta_convection:**
- `0.01`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å, –º–µ–¥–ª–µ–Ω–Ω–µ–µ
- `0.025`: –ë–∞–ª–∞–Ω—Å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
- `0.05`: –ë—ã—Å—Ç—Ä–µ–µ, –Ω–æ –±–æ–ª—å—à–µ –æ—à–∏–±–æ–∫ (~10%)

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### –í `include/acceleration/Octree.h` –∏ `src/acceleration/Octree.cpp`:

**–ì–õ–ê–í–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–¥–µ–ª—å–Ω—ã–π –∫—Ä–∏—Ç–µ—Ä–∏–π theta –¥–ª—è —Å—Ç–æ–∫—Å–ª–µ—Ç–∞**

1. **–î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ä–∞–º–µ—Ç—Ä `theta_convection`:**
   ```cpp
   double theta_convection;  // –ö—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è –∫–æ–Ω–≤–µ–∫—Ü–∏–∏ (–±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π)
   ```
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: `theta_convection = theta / 10.0`
   - –î–ª—è theta=0.25 ‚Üí theta_convection=0.025

2. **–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `shouldOpenConvection()`:**
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –±–æ–ª–µ–µ —Å—Ç—Ä–æ–≥–∏–π –∫—Ä–∏—Ç–µ—Ä–∏–π –¥–ª—è —Å—Ç–æ–∫—Å–ª–µ—Ç–∞
   - –£—á–∏—Ç—ã–≤–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ (~ 1/r vs 1/r‚Å∑)

3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –û—à–∏–±–∫–∏ —Å–Ω–∏–∑–∏–ª–∏—Å—å —Å 1238% –¥–æ 153% (–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è)
   - –û—à–∏–±–∫–∏ —Å–Ω–∏–∑–∏–ª–∏—Å—å —Å 27% –¥–æ 3.4% (—Å—Ä–µ–¥–Ω—è—è)
   - **–£–ª—É—á—à–µ–Ω–∏–µ –≤ 8 —Ä–∞–∑!**

### –í `benchmark_velocity_analysis.cpp`:

1. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞** (—Å—Ç—Ä–æ–∫–∞ 193):
   ```cpp
   // –ë–´–õ–û (–∏–∑–±—ã—Ç–æ—á–Ω–∞—è –≤–ª–æ–∂–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞):
   if (naive_mag > 1e-15) {
       if (naive_vel[i].v_total_mag > 1e-15) { // –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
           total_conv_contribution += ...;
       }
   }
   
   // –°–¢–ê–õ–û:
   if (naive_mag > 1e-15) {
       total_conv_contribution += ...;  // –£–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –≤—ã—à–µ
   }
   ```

2. **–ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫** (—Å—Ç—Ä–æ–∫–∏ 276-285):
   ```cpp
   // –¢–µ–ø–µ—Ä—å –≤—ã–≤–æ–¥—è—Ç—Å—è –û–ë–ï –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:
   // ‚ü®|u|/|v|‚ü©  - —Å—Ä–µ–¥–Ω–µ–µ –æ—Ç–Ω–æ—à–µ–Ω–∏–π (–ø–æ –∫–∞–ø–ª—è–º)
   // ‚ü®|u|‚ü©/‚ü®|v|‚ü© - –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ä–µ–¥–Ω–∏—Ö (–æ–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
   ```

## –ö–∞–∫ –≤—ã—á–∏—Å–ª—è–µ—Ç—Å—è –∫–æ–Ω–≤–µ–∫—Ç–∏–≤–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å

### –î–≤—É—Ö—ç—Ç–∞–ø–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å:

**–≠—Ç–∞–ø 1: –†–∞—Å—á–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–∏–ª**
```cpp
// DipoleForceCalculator –≤—ã—á–∏—Å–ª—è–µ—Ç —Å–∏–ª—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ø–∞–º—è—Ç–∏ –∫–∞–ø–µ–ª—å
for (size_t i = 0; i < n; ++i) {
    for (size_t j = i + 1; j < n; ++j) {
        auto force = calculator.calculateForce(droplets[i], droplets[j]);
        
        droplets[i].fx += force[0];  // ‚Üê –°–∏–ª–∞ –°–û–•–†–ê–ù–Ø–ï–¢–°–Ø –≤ –ø–∞–º—è—Ç–∏
        droplets[i].fy += force[1];
        droplets[i].fz += force[2];
    }
}
```

**–≠—Ç–∞–ø 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö —Å–∏–ª –¥–ª—è –∫–æ–Ω–≤–µ–∫—Ü–∏–∏**
```cpp
// StokesletCalculator –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –°–û–•–†–ê–ù–ï–ù–ù–´–ï —Å–∏–ª—ã
inline std::array<double, 3> calculateConvectionVelocity(
    const Droplet& i, const Droplet& j) const {
    
    // –ë–µ—Ä–µ–º –°–û–•–†–ê–ù–ï–ù–ù–£–Æ —Å–∏–ª—É –∏–∑ –ø–∞–º—è—Ç–∏ –∫–∞–ø–ª–∏ j
    double fx = j.fx;  // ‚Üê –ò–∑ –ø–∞–º—è—Ç–∏!
    double fy = j.fy;
    double fz = j.fz;
    
    // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –≤ —Ñ–æ—Ä–º—É–ª—É —Å—Ç–æ–∫—Å–ª–µ—Ç–∞ (—Ç–µ–Ω–∑–æ—Ä –ì—Ä–∏–Ω–∞)
    double V_x = eta_const * ((inv_r + x*x*inv_r3) * fx + ...);
    // ...
}
```

**–§–∏–∑–∏–∫–∞:** –ö–∞–ø–ª—è j –ø–æ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º —Å–∏–ª—ã F_j —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Ç–æ–∫ –≤ –≤—è–∑–∫–æ–π —Å—Ä–µ–¥–µ (—Å—Ç–æ–∫—Å–ª–µ—Ç), –∫–æ—Ç–æ—Ä—ã–π —É–≤–ª–µ–∫–∞–µ—Ç –∫–∞–ø–ª—é i.

